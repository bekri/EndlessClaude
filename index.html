<!-- index.html: Upgraded with image upload to Imgur + safe code block rendering + Markdown + language autodetect -->

<!-- Original head content preserved -->
<head>
  <!-- ... your existing head ... -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-bash.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.css" rel="stylesheet"/>
</head>

<!-- Inside input-container, before send-button -->
<div class="input-container">
  <input type="file" id="fileUpload" onchange="handleFileUpload(event)" style="margin-bottom: 10px" />
  <div class="message-input-wrapper">
    <textarea id="query" rows="3" placeholder="Type your message here..."></textarea>
    <button class="send-button" id="submit" onclick="sendQuery()">
      <i class="fas fa-paper-plane"></i>
      <span></span>
    </button>
  </div>
  <button class="btn-custom btn-secondary d-none d-md-block" onclick="clearChat()">
    <i class="fas fa-trash"></i>
    <span>Clear Chat</span>
  </button>
</div>

<script>
  function escapeHTML(html) {
    return html
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  function formatMessageContent(content) {
    // Replace triple backticks with fenced code blocks that can be parsed by marked
    const formatted = content.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
      const safeCode = escapeHTML(code);
      return `<pre><code class="language-${lang || 'plaintext'}">${safeCode}</code></pre>`;
    });
    return marked.parse(formatted);
  }

  async function uploadToImgur(file) {
    const formData = new FormData();
    formData.append("image", file);

    const res = await fetch("https://api.imgur.com/3/image", {
      method: "POST",
      headers: {
        Authorization: "Client-ID 66d88a744ba9542"
      },
      body: formData
    });

    const json = await res.json();
    if (json.success) {
      return json.data.link;
    } else {
      throw new Error("Imgur upload failed");
    }
  }

  async function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    try {
      const imgurURL = await uploadToImgur(file);
      const markdown = `![uploaded image](${imgurURL})`;
      addMessage(markdown, true);
    } catch (error) {
      addMessage(`Upload failed: ${error.message}`, true);
    }

    event.target.value = '';
  }

  function updateChatDisplay() {
    const chatHistoryDiv = document.getElementById('chatHistory');
    chatHistoryDiv.innerHTML = '';

    chatHistory.forEach((message) => {
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${message.isUser ? 'user-message' : 'ai-message'}`;
      messageDiv.innerHTML = `
        <div class="message-header">
          <span>${message.isUser ? 'You' : 'Claude'} â€¢ ${message.timestamp}</span>
          <div class="message-actions">
            <button class="btn-icon" onclick="copyMessage('${message.content.replace(/'/g, "\\'")}')">
              <i class="fas fa-copy"></i>
            </button>
          </div>
        </div>
        <div class="message-content">${formatMessageContent(message.content)}</div>
      `;

      chatHistoryDiv.appendChild(messageDiv);
    });

    Prism.highlightAll();
    chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
  }
</script>
